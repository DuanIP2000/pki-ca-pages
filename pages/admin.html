<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKI证书管理系统 - 管理员</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass-effect{background:rgba(255,255,255,0.9);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.6)}
        .input-focus{transition:all .2s ease}
        .btn-hover{transition:all .2s ease}
        .btn-hover:hover{transform:translateY(-1px)}
    </style>
</head>
<body class="bg-gradient-to-br from-sky-100 via-sky-200 to-sky-300 min-h-screen flex items-center justify-center p-4">
    <div class="relative z-10 w-full max-w-7xl">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-white bg-opacity-30 rounded-full mb-4">
                <i class="fas fa-user-shield text-3xl text-blue-700"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">管理员控制台</h1>
            <p id="welcomeText" class="text-slate-700"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="glass-effect rounded-2xl p-8 shadow-2xl lg:col-span-7">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-sm font-medium">待审批证书申请</div>
                    <div class="flex gap-2">
                        <input id="filterUser" type="text" class="input-focus px-3 py-2 bg-white border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400" placeholder="按用户名筛选">
                        <button id="refreshRequests" class="btn-hover px-4 py-2 bg-sky-600 text-white rounded-lg">刷新</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-slate-600">申请ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-slate-600">用户名</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-slate-600">状态</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-slate-600">申请时间</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-slate-600">操作</th>
                            </tr>
                        </thead>
                        <tbody id="requestsBody" class="bg-white divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-8 shadow-2xl lg:col-span-5">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-sm font-medium">吊销记录</div>
                    <button id="refreshCRL" class="btn-hover px-4 py-2 bg-sky-600 text-white rounded-lg">刷新</button>
                </div>
                <div id="crlList" class="space-y-3"></div>
            </div>
        </div>

        <div id="statusMessage" class="mt-6 hidden">
            <div class="flex items-center p-3 rounded-lg">
                <i id="statusIcon" class="fas mr-2 text-slate-600"></i>
                <span id="statusText" class="text-slate-800"></span>
            </div>
        </div>
    </div>

    <script>
        class AdminConsole {
            constructor(){
                this.baseURL='http://localhost:8080';
                this.jwt=sessionStorage.getItem('pki_jwt');
                this.username=sessionStorage.getItem('pki_username');
                this.init();
            }
            init(){
                if(!this.jwt){window.location.href='./login.html';return}
                const welcome=document.getElementById('welcomeText');
                if(welcome&&this.username)welcome.textContent=`欢迎，${this.username}`;
                document.getElementById('refreshRequests').addEventListener('click',()=>this.loadRequests());
                document.getElementById('refreshCRL').addEventListener('click',()=>this.loadCRL());
                document.getElementById('filterUser').addEventListener('input',()=>this.renderRequests());
                this.loadRequests();
                this.loadCRL();
            }
            showStatus(message,type){
                const statusDiv=document.getElementById('statusMessage');
                const icon=document.getElementById('statusIcon');
                const text=document.getElementById('statusText');
                statusDiv.classList.remove('hidden');
                icon.classList.remove('fa-check-circle','fa-exclamation-circle','fa-info-circle');
                if(type==='success')icon.classList.add('fa-check-circle');
                else if(type==='error')icon.classList.add('fa-exclamation-circle');
                else icon.classList.add('fa-info-circle');
                text.textContent=message;
            }
            async loadRequests(){
                try{
                    const resp=await fetch(`${this.baseURL}/api/certificates/requests`,{headers:{'Authorization':`Bearer ${this.jwt}`}});
                    const data=await resp.json();
                    if(data&&data.success){
                        this.requests=Array.isArray(data.data)?data.data:[];
                        this.renderRequests();
                    }else{this.requests=[];this.renderRequests()}
                }catch(e){this.requests=[];this.renderRequests()}
            }
            renderRequests(){
                const body=document.getElementById('requestsBody');
                const filter=document.getElementById('filterUser').value.trim().toLowerCase();
                body.innerHTML='';
                const items=(this.requests||[]).filter(r=>!filter||String(r.username||'').toLowerCase().includes(filter));
                if(items.length===0){
                    const tr=document.createElement('tr');
                    const td=document.createElement('td');
                    td.colSpan=5;td.className='px-4 py-3 text-slate-600 text-sm';td.textContent='暂无申请';
                    tr.appendChild(td);body.appendChild(tr);return
                }
                items.forEach(r=>{
                    const tr=document.createElement('tr');
                    const allow=String(r.status||'').toUpperCase()==='PENDING';
                    tr.innerHTML=`
                        <td class='px-4 py-3 text-slate-900'>${r.requestId??''}</td>
                        <td class='px-4 py-3 text-slate-900'>${r.username??''}</td>
                        <td class='px-4 py-3 text-slate-700'>${r.status??''}</td>
                        <td class='px-4 py-3 text-slate-700'>${r.requestTime??''}</td>
                        <td class='px-4 py-3 text-right'>
                            <button class='px-3 py-2 bg-sky-600 text-white rounded ${allow?'':'opacity-50 cursor-not-allowed'}' data-action='approve'>同意</button>
                        </td>`;
                    const btn=tr.querySelector("[data-action='approve']");
                    if(allow)btn.addEventListener('click',()=>this.approveRequest(r.requestId));
                    body.appendChild(tr);
                });
            }
            async approveRequest(id){
                if(!id)return;
                try{
                    const resp=await fetch(`${this.baseURL}/api/certificates/requests/${id}/approve`,{method:'POST',headers:{'Authorization':`Bearer ${this.jwt}`}});
                    const data=await resp.json();
                    if(data&&data.success){this.showStatus('审批通过，已签发证书','success');await this.loadRequests()}else{this.showStatus((data&&data.message)||'审批失败','error')}
                }catch(e){this.showStatus('审批请求失败','error')}
            }
            async loadCRL(){
                try{
                    const resp=await fetch(`${this.baseURL}/api/crl`);
                    const data=await resp.json();
                    const list=document.getElementById('crlList');
                    list.innerHTML='';
                    if(data&&data.success&&Array.isArray(data.data)&&data.data.length>0){
                        data.data.forEach(x=>{
                            const row=document.createElement('div');
                            row.className='border border-slate-200 rounded-lg p-3 bg-white';
                            row.innerHTML=`
                                <div class='flex justify-between items-center'>
                                    <div>
                                        <div class='text-slate-900 font-medium'>CRL ID：${x.crlid??''}</div>
                                        <div class='text-slate-600 text-sm'>原因：${x.reason??''}</div>
                                    </div>
                                    <div class='text-slate-700 text-sm'>时间：${x.revokeTime??''}</div>
                                </div>`;
                            list.appendChild(row);
                        });
                    }else{
                        const empty=document.createElement('div');
                        empty.className='text-slate-600 text-sm';
                        empty.textContent='暂无吊销记录';
                        list.appendChild(empty);
                    }
                }catch(e){
                    const list=document.getElementById('crlList');
                    list.innerHTML='<div class="text-slate-600 text-sm">加载失败</div>';
                }
            }
        }
        document.addEventListener('DOMContentLoaded',()=>{new AdminConsole()});
    </script>
</body>
</html>
